{% extends 'base.html' %}

{% block title %}Buat Laporan / Keluhan Baru{% endblock %}

{% block content %}
<section class="container py-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <h2 class="text-center fw-bold mb-4" style="color: var(--secondary-blue)">Sampaikan Aduan Anda</h2>
            <div class="card shadow-lg p-3 p-md-5">
                
                <ul class="nav nav-pills nav-fill mb-4 border-bottom pb-3" id="formSwitchTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active fw-bold" id="laporan-tab" data-bs-toggle="tab" data-bs-target="#laporan-form" type="button" role="tab" aria-controls="laporan-form" aria-selected="true" style="color: var(--dark-text);">
                            <i class="bi bi-megaphone me-2"></i> Laporan (Aduan Masalah)
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link fw-bold" id="keluhan-tab" data-bs-toggle="tab" data-bs-target="#keluhan-form" type="button" role="tab" aria-controls="keluhan-form" aria-selected="false" style="color: var(--dark-text);">
                            <i class="bi bi-chat-dots me-2"></i> Keluhan / Pertanyaan
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="formSwitchTabContent">
                    
                    <div class="tab-pane fade show active" id="laporan-form" role="tabpanel" aria-labelledby="laporan-tab">
                        <h4 class="mb-4 text-center">Formulir Pengajuan Laporan</h4>
                        <form method="POST" action="{{ url_for('public_routes.lapor') }}" enctype="multipart/form-data">
                            <input type="hidden" name="form_type" value="laporan">
                            
                            <div class="mb-3">
                                <label for="id_kategori_laporan" class="form-label">Kategori Laporan <span class="text-danger">*</span></label>
                                <select class="form-select" id="id_kategori_laporan" name="id_kategori_laporan" required>
                                    <option value="" disabled selected>Pilih Kategori</option>
                                    {% for kategori in kategori_laporan %}
                                    <option value="{{ kategori.id }}">{{ kategori.nama }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="deskripsi_laporan" class="form-label">Deskripsi Laporan <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="deskripsi_laporan" name="deskripsi" rows="4" placeholder="Jelaskan detail laporan Anda secara lengkap (minimal 20 karakter)" minlength="20" required></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="id_kecamatan_laporan" class="form-label">Lokasi Kejadian (Kecamatan) <span class="text-danger">*</span></label>
                                <select class="form-select" id="id_kecamatan_laporan" name="id_kecamatan" data-kecamatan-data="{{ data_kecamatan | tojson }}" required>
                                    <option value="" disabled selected>Pilih Kecamatan</option>
                                    {% for kec in data_kecamatan %}
                                    <option value="{{ kec.id }}" data-lat="{{ kec.lat }}" data-long="{{ kec.long }}">{{ kec.nama_kecamatan }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="nama_jalan" class="form-label">Nama Jalan/Lokasi Detail <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nama_jalan" name="nama_jalan" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="nama_kelurahan" class="form-label">Kelurahan <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nama_kelurahan" name="nama_kelurahan" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Tentukan Titik Koordinat Peta</label>
                                <div id="map-laporan" style="height: 300px; border-radius: 0.5rem; border: 1px solid #ccc;"></div>
                                <small class="form-text text-muted">Klik pada peta untuk menentukan lokasi yang tepat.</small>
                                <input type="hidden" id="lat_peta" name="lat_peta" required>
                                <input type="hidden" id="long_peta" name="long_peta" required>
                            </div>

                            <div class="mb-4">
                                <label for="foto" class="form-label">Foto Bukti (Opsional)</label>
                                <input class="form-control" type="file" id="foto" name="foto" accept="image/*">
                                <small class="form-text text-muted">Maksimal ukuran file 2MB (jpg, jpeg, png).</small>
                            </div>
                            
                            <h5 class="mt-4 mb-3" style="color: var(--accent-green);">Data Pelapor (Opsional)</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="nama_pelapor" class="form-label">Nama Pelapor</label>
                                    <input type="text" class="form-control" id="nama_pelapor" name="nama_pelapor">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="no_hp_pelapor" class="form-label">Nomor HP</label>
                                    <input type="tel" class="form-control" id="no_hp_pelapor" name="no_hp_pelapor" placeholder="08xxxxxxxxxx">
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-lg btn-success">
                                    <i class="bi bi-send-check me-2"></i> Kirim Laporan
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="tab-pane fade" id="keluhan-form" role="tabpanel" aria-labelledby="keluhan-tab">
                        <h4 class="mb-4 text-center">Formulir Pengajuan Keluhan / Pertanyaan</h4>
                        <form method="POST" action="{{ url_for('public_routes.lapor') }}">
                            <input type="hidden" name="form_type" value="keluhan">
                            
                            <div class="mb-3">
                                <label for="id_jenis_keluhan" class="form-label">Jenis Keluhan <span class="text-danger">*</span></label>
                                <select class="form-select" id="id_jenis_keluhan" name="id_jenis_keluhan" required>
                                    <option value="" disabled selected>Pilih Jenis</option>
                                    {% for jenis in jenis_keluhan %}
                                    <option value="{{ jenis.id }}">{{ jenis.nama }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="deskripsi_keluhan" class="form-label">Detail Keluhan/Pertanyaan <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="deskripsi_keluhan" name="isi_keluhan" rows="4" placeholder="Tuliskan keluhan atau pertanyaan Anda di sini." minlength="10" required></textarea>
                            </div>

                            <h5 class="mt-4 mb-3" style="color: var(--accent-green);">Data Pengirim</h5>
                            <div class="mb-3">
                                <label for="nama_pengirim" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="nama_pengirim" name="nama_pengirim" required>
                            </div>
                            <div class="mb-4">
                                <label for="no_hp_pengirim" class="form-label">Nomor HP <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="no_hp_pengirim" name="no_hp_pengirim" placeholder="08xxxxxxxxxx" required>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-lg btn-primary" style="background-color: var(--secondary-blue); border-color: var(--secondary-blue);">
                                    <i class="bi bi-chat-text me-2"></i> Kirim Keluhan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }} <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Peta harus diinisialisasi di sini karena berada di dalam content block
        const mapElement = document.getElementById('map-laporan');
        const defaultLat = -5.4200; // Pusat Bandar Lampung (Default MapConfig dari utils/map_helper)
        const defaultLong = 105.2667;
        const defaultZoom = 13;
        const tileUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

        let map, marker;
        
        // 1. Inisialisasi Peta
        if (mapElement) {
            map = L.map('map-laporan').setView([defaultLat, defaultLong], defaultZoom);

            L.tileLayer(tileUrl, {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Tambahkan marker awal di pusat kota
            marker = L.marker([defaultLat, defaultLong], {draggable: true}).addTo(map);
            
            // Set input koordinat awal
            document.getElementById('lat_peta').value = defaultLat.toFixed(5);
            document.getElementById('long_peta').value = defaultLong.toFixed(5);

            // 2. Logic Drag Marker
            marker.on('dragend', function(e) {
                const latlng = marker.getLatLng();
                document.getElementById('lat_peta').value = latlng.lat.toFixed(5);
                document.getElementById('long_peta').value = latlng.lng.toFixed(5);
            });
            
            // 3. Logic Klik Peta
            map.on('click', function(e) {
                marker.setLatLng(e.latlng);
                document.getElementById('lat_peta').value = e.latlng.lat.toFixed(5);
                document.getElementById('long_peta').value = e.latlng.lng.toFixed(5);
            });
        }
        
        // 4. Logic Dropdown Kecamatan (Memusatkan Peta)
        const kecamatanSelect = document.getElementById('id_kecamatan_laporan');
        if (kecamatanSelect && map) {
            kecamatanSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const lat = selectedOption.getAttribute('data-lat');
                const long = selectedOption.getAttribute('data-long');

                if (lat && long) {
                    const newLatLong = [parseFloat(lat), parseFloat(long)];
                    
                    // Pindahkan pusat peta dan marker
                    map.setView(newLatLong, 14); // Zoom sedikit lebih dekat
                    marker.setLatLng(newLatLong);

                    // Perbarui hidden input untuk default koordinat laporan
                    document.getElementById('lat_peta').value = newLatLong[0].toFixed(5);
                    document.getElementById('long_peta').value = newLatLong[1].toFixed(5);
                }
            });
        }
        
        // 5. Logic Refresh Peta saat Tab Berubah (Penting agar peta tidak blank)
        const laporanTab = document.getElementById('laporan-tab');
        if (laporanTab) {
            laporanTab.addEventListener('shown.bs.tab', function (e) {
                if (map) {
                    map.invalidateSize();
                }
            });
        }
    });
</script>
{% endblock %}